<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Binance 即時價格監控</title>
<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
}
header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}
header input {
    margin-left: 10px;
    width: 200px;
}
table {
    width: 100%;
    border-collapse: collapse;
}
th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
}
th {
    background-color: #f4f4f4;
}
select, input {
    width: 90%;
}
.positive {
    color: green;
}
.negative {
    color: red;
}
</style>
</head>

<body>

<header>
    <strong>使用者 ID：</strong>
    <input id="userId" placeholder="英數組合 ID">
    <button onclick="initUser()">登入</button>
</header>

<h2>Binance WebSocket 即時價格監控（槓桿固定 100x）</h2>
<button onclick="addRow()">新增一筆</button>

<table>
<thead>
<tr>
    <th>姓名</th>
    <th>幣種</th>
    <th>買入價</th>
    <th>即時價格</th>
    <th>獲利比率（100x）</th>
</tr>
</thead>
<tbody id="cryptoTable"></tbody>
</table>

<script>
const FIXED_LEVERAGE = 100;
let sockets = {};
let storageKey = null;

/* ========= 使用者初始化 ========= */

function initUser() {
    const id = document.getElementById("userId").value.trim();
    if (!/^[a-zA-Z0-9]+$/.test(id)) {
        alert("使用者 ID 只能是英文與數字");
        return;
    }
    storageKey = "cryptoMonitorData_" + id;
    document.getElementById("cryptoTable").innerHTML = "";
    loadData();
}

/* ========= 資料儲存 ========= */

function saveData() {
    if (!storageKey) return;

    const rows = document.querySelectorAll("#cryptoTable tr");
    const data = [];

    rows.forEach(row => {
        data.push({
            name: row.cells[0].querySelector("input").value,
            symbol: row.cells[1].querySelector("select").value,
            buyPrice: row.cells[2].querySelector("input").value
        });
    });

    localStorage.setItem(storageKey, JSON.stringify(data));
}

function loadData() {
    const data = JSON.parse(localStorage.getItem(storageKey) || "[]");
    data.forEach(item => addRow(item));
}

/* ========= UI ========= */

function addRow(saved = {}) {
    if (!storageKey) {
        alert("請先輸入使用者 ID");
        return;
    }

    const row = document.createElement("tr");

    row.innerHTML = `
        <td><input value="${saved.name || ""}" oninput="saveData()"></td>
        <td>
            <select onchange="changeSymbol(this)">
                <option value="BTCUSDT" ${saved.symbol === "BTCUSDT" ? "selected" : ""}>BTCUSDT</option>
                <option value="ETHUSDT" ${saved.symbol === "ETHUSDT" ? "selected" : ""}>ETHUSDT</option>
            </select>
        </td>
        <td>
            <input type="number" step="0.0001" value="${saved.buyPrice || ""}" oninput="saveData()">
        </td>
        <td class="price">--</td>
        <td class="profit">--</td>
    `;

    document.getElementById("cryptoTable").appendChild(row);

    connectWS(row.cells[1].querySelector("select"));
}

/* ========= WebSocket ========= */

function changeSymbol(select) {
    connectWS(select);
    saveData();
}

function connectWS(select) {
    const symbol = select.value.toLowerCase();
    if (sockets[symbol]) return;

    const ws = new WebSocket(`wss://stream.binance.com:9443/ws/${symbol}@trade`);
    sockets[symbol] = ws;

    ws.onmessage = e => {
        const data = JSON.parse(e.data);
        updateRows(symbol, parseFloat(data.p));
    };
}

function updateRows(symbol, price) {
    const rows = document.querySelectorAll("#cryptoTable tr");

    rows.forEach(row => {
        const select = row.cells[1].querySelector("select");
        if (select.value.toLowerCase() !== symbol) return;

        const buyInput = row.cells[2].querySelector("input");
        const priceCell = row.querySelector(".price");
        const profitCell = row.querySelector(".profit");

        const buy = parseFloat(buyInput.value);
        if (isNaN(buy)) return;

        priceCell.textContent = price.toFixed(4);

        const raw = ((price - buy) / buy) * 100;
        const result = raw * FIXED_LEVERAGE;

        profitCell.textContent = result.toFixed(2) + "%";
        profitCell.className = "profit " + (result >= 0 ? "positive" : "negative");
    });
}
</script>

</body>
</html>
